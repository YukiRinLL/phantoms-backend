<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <title>STOMP åœ¨çº¿æµ‹è¯•å·¥å…·</title>
    <style>
        body{font-family:Arial;margin:20px;background:#f7f7f7}
        label{display:block;margin:8px 0;font-weight:bold}
        input,textarea,button{width:100%;padding:6px;margin-bottom:10px}
        #log{border:1px solid #ccc;height:260px;overflow-y:auto;padding:6px;background:#fff;white-space:pre-wrap}
        .sent{color:#0b7500}.recv{color:#0075c4}
    </style>
</head>
<body>
<h2>STOMP WebSocket åœ¨çº¿æµ‹è¯•</h2>

<!-- è¿æ¥å‚æ•° -->
<label>WebSocket URL
    <input id="wsUrl" value="ws://localhost:8080/ws"/>
</label>

<label>è®¢é˜…ç›®çš„åœ°
    <input id="subDest" value="/topic/greetings"/>
</label>

<label>å‘é€ç›®çš„åœ°
    <input id="sendDest" value="/app/hello"/>
</label>

<label>JSON æ¶ˆæ¯å†…å®¹
    <textarea id="msgBody" rows="4">{"name":"Tom"}</textarea>
</label>

<button id="btnConnect">è¿æ¥</button>
<button id="btnSend" disabled>å‘é€</button>
<button id="btnDisconnect" disabled>æ–­å¼€</button>

<div id="log">æ—¥å¿—åŒº...\n</div>

<!-- stomp.js CDN -->
<!--<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>-->
<!-- å›½å†… CDN -->
<!--<script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/@stomp/stompjs/7.0.0/stomp.umd.min.js"></script>-->
<!-- å¤‡ç”¨ -->
<!--<script src="https://unpkg.com/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>-->

<script src="stomp.umd.min.js"></script>

<script>
    const urlInput   = document.getElementById('wsUrl');
    const subInput   = document.getElementById('subDest');
    const sendInput  = document.getElementById('sendDest');
    const msgInput   = document.getElementById('msgBody');
    const logArea    = document.getElementById('log');
    const btnConn    = document.getElementById('btnConnect');
    const btnSend    = document.getElementById('btnSend');
    const btnDisc    = document.getElementById('btnDisconnect');

    let stompClient = null;

    function log(msg, cls=''){
      logArea.insertAdjacentHTML('beforeend', `<div class="${cls}">${new Date().toLocaleTimeString()} ${msg}</div>`);
      logArea.scrollTop = logArea.scrollHeight;
    }

    btnConn.onclick = () => {
      if (stompClient && stompClient.connected) return;
      const socket = new WebSocket(urlInput.value.trim());
      stompClient = Stomp.over(socket);
      stompClient.debug = str => log(str, 'debug');

      stompClient.connect({}, frame => {
        log('å·²è¿æ¥', 'sent');
        btnSend.disabled = false;
        btnDisc.disabled = false;

        stompClient.subscribe(subInput.value.trim(), message => {
          log(`æ”¶åˆ°ï¼š${message.body}`, 'recv');
        });
      }, err => {
        log('è¿æ¥é”™è¯¯ï¼š' + err, 'recv');
      });
    };

    btnSend.onclick = () => {
      if (!stompClient || !stompClient.connected) return;
      try {
        const body = msgInput.value.trim();
        JSON.parse(body); // ç®€å•æ ¡éªŒ
        stompClient.send(sendInput.value.trim(), {}, body);
        log(`å‘é€ï¼š${body}`, 'sent');
      } catch (e) {
        alert('JSON æ ¼å¼é”™è¯¯ï¼');
      }
    };

    btnDisc.onclick = () => {
      if (stompClient) {
        stompClient.disconnect(() => log('ğŸ”Œ å·²æ–­å¼€', 'sent'));
        btnSend.disabled = true;
        btnDisc.disabled = true;
      }
    };
</script>
</body>
</html>